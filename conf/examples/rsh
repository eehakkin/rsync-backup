#! /bin/sh -Ceu

# A sample conf/rsh file
# ======================

# Locate the script.
me=$( which -- "${0}" || ls -d -- "${0}" )
dir=$( dirname -- "${me}" )
dir=$( readlink -f -- "${dir}" )
case ${dir} in */.misc/* ) dir=/${dir#*/.misc/} ;; esac
case ${dir} in */.rw/*   ) dir=${dir%%/.rw/*}/${dir#*/.rw/} ;; esac
me=${dir}/$( basename -- "${me}" )

# Use a proxy command for root.
case " ${*} " in
*' -l root '* ) set -- -o ProxyCommand="\
'${me}' -l '${SUDO_USER:-backup}' -p '%p' -- '%h' nc -w 60 -- localhost '%p'\
" "${@}" ;;
esac

# Use some extra options.
[ ! -f "${dir}/id_rsa"     ] || set -- -i "${dir}/id_rsa"     "${@}"
[ ! -f "${dir}/ssh_config" ] || set -- -F "${dir}/ssh_config" "${@}"
set -- -o ClearAllForwardings=yes -o StrictHostKeyChecking=yes "${@}"

# Execute SSH.
cd -- / && exec ssh "${@}"
