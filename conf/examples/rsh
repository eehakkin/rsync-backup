#! /bin/sh -Ceu

# A sample conf/rsh file
# ======================

# Locate the script.
me=$( which -- "${0}" || ls -d -- "${0}" )
dir=$( dirname -- "${me}" )
dir=$( readlink -f -- "${dir}" )
case ${dir} in */.misc/* ) dir=/${dir#*/.misc/} ;; esac
case ${dir} in */.ro/*   ) dir=${dir%%/.ro/*}/${dir#*/.ro/} ;; esac
case ${dir} in */.rw/*   ) dir=${dir%%/.rw/*}/${dir#*/.rw/} ;; esac
me=${dir}/$( basename -- "${me}" )

# Use identity files.
for identity_file in "${dir}/ssh"/id_*[9a]
do
	[ ! -f "${identity_file}" ] || set -- -i "${identity_file}" "${@}"
done

# Use a proxy command for root.
case " ${*} " in
*' -l root '* ) set -- -o ProxyCommand="\
'${me}' -l '${SUDO_USER:-backup}' -p '%p' -W 'localhost:%p' -- '%h'\
" "${@}" ;;
esac

# Use some extra options.
if [ ! -f "${dir}/ssh/config" ]
then
	set -- \
		-o ControlMaster=auto \
		-o ControlPersist=1m \
		-o VerifyHostKeyDNS=yes \
		"${@}"
else
	set -- -F "${dir}/ssh/config" "${@}"
fi
[ ! -f "${dir}/ssh/known_hosts" ] || set -- \
	-o UserKnownHostsFile="${dir}/ssh/known_hosts" "${@}"
set -- -o ClearAllForwardings=yes -o StrictHostKeyChecking=yes "${@}"

# Execute SSH.
cd -- / && exec ssh "${@}"
